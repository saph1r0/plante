<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalle de Planta - PlantCare</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="css/plantas.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <nav class="nav">
            <h1><i class="fas fa-seedling"></i> PlantCare</h1>
            <div class="nav-links">
                <a href="dashboard.html"><i class="fas fa-chart-pie"></i> Dashboard</a>
                <a href="mis-plantas.html"><i class="fas fa-leaf"></i> Mis Plantas</a>
                <a href="registro-planta.html"><i class="fas fa-plus"></i> Agregar Planta</a>
                <button onclick="cerrarSesion()"><i class="fas fa-sign-out-alt"></i> Salir</button>
            </div>
        </nav>
    </header>

    <!-- Contenido principal -->
    <div class="main-content">
        <!-- Breadcrumb -->
        <div class="breadcrumb">
            <i class="fas fa-home"></i> <a href="dashboard.html">Inicio</a> / 
            <a href="mis-plantas.html">Mis Plantas</a> / <span id="breadcrumb-nombre">Detalle</span>
        </div>

        <!-- Loading -->
        <div id="loading" class="loading">
            <i class="fas fa-spinner"></i> Cargando informaci√≥n de la planta...
        </div>

        <!-- Contenido de la planta -->
        <div id="contenido-planta" class="hidden">
            <!-- Page Header -->
            <div class="page-header">
                <h1><i class="fas fa-leaf"></i> <span id="titulo-planta"></span></h1>
                <div>
                    <button class="btn btn-primary" onclick="abrirModalCuidado()">
                        <i class="fas fa-hand-holding-water"></i> Registrar Cuidado
                    </button>
                    <a id="btn-editar" href="#" class="btn btn-secondary">
                        <i class="fas fa-edit"></i> Editar
                    </a>
                    <a href="mis-plantas.html" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Volver
                    </a>
                </div>
            </div>

            <!-- Informaci√≥n principal -->
            <div class="plant-detail">
                <div class="plant-detail-image">
                    <img id="imagen-planta" src="" alt="">
                    <div style="margin-top: 1rem;">
                        <span id="estado-planta" class="plant-status"></span>
                    </div>
                </div>
                <div class="plant-detail-info">
                    <h2 id="apodo-planta"></h2>
                    <div class="scientific-name" id="nombre-cientifico"></div>
                    
                    <div class="info-grid">
                        <div class="info-item">
                            <i class="fas fa-map-marker-alt"></i>
                            <span id="ubicacion-planta"></span>
                        </div>
                        <div class="info-item">
                            <i class="fas fa-calendar-plus"></i>
                            <span id="fecha-registro"></span>
                        </div>
                        <div class="info-item">
                            <i class="fas fa-droplet"></i>
                            <span id="ultimo-cuidado"></span>
                        </div>
                        <div class="info-item">
                            <i class="fas fa-tag"></i>
                            <span id="tipo-planta"></span>
                        </div>
                    </div>

                    <div id="descripcion-planta" style="margin: 1rem 0; padding: 1rem; background: var(--color-cream-light); border-radius: 8px;">
                    </div>

                    <div id="notas-personales" class="hidden" style="margin: 1rem 0; padding: 1rem; background: var(--color-green-light); border-radius: 8px;">
                        <h4><i class="fas fa-sticky-note"></i> Notas Personales</h4>
                        <p id="texto-notas"></p>
                    </div>
                </div>
            </div>

            <!-- Estad√≠sticas -->
            <div class="cards-grid">
                <div class="card stat-card">
                    <i class="fas fa-calendar-check"></i>
                    <span class="stat-number" id="dias-registrada">0</span>
                    <span class="stat-label">D√≠as Registrada</span>
                </div>
                <div class="card stat-card">
                    <i class="fas fa-hand-holding-water"></i>
                    <span class="stat-number" id="total-cuidados">0</span>
                    <span class="stat-label">Cuidados Realizados</span>
                </div>
                <div class="card stat-card">
                    <i class="fas fa-clock"></i>
                    <span class="stat-number" id="dias-ultimo-cuidado">0</span>
                    <span class="stat-label">D√≠as Desde √öltimo Cuidado</span>
                </div>
                <div class="card stat-card">
                    <i class="fas fa-heart-pulse"></i>
                    <span class="stat-number" id="estado-salud">N/A</span>
                    <span class="stat-label">Estado de Salud</span>
                </div>
            </div>

            <!-- Informaci√≥n de cuidados recomendados -->
            <div class="form-container">
                <h2><i class="fas fa-book"></i> Cuidados Recomendados</h2>
                <div id="cuidados-recomendados" class="cards-grid">
                    <!-- Se llena din√°micamente -->
                </div>
            </div>

            <!-- Historial de cuidados -->
            <div class="form-container">
                <h2><i class="fas fa-history"></i> Historial de Cuidados</h2>
                <div id="historial-cuidados">
                    <!-- Se llena din√°micamente -->
                </div>
            </div>

            <!-- Pr√≥ximos cuidados -->
            <div class="form-container">
                <h2><i class="fas fa-calendar-alt"></i> Pr√≥ximos Cuidados Sugeridos</h2>
                <div id="proximos-cuidados" class="cards-grid">
                    <!-- Se llena din√°micamente -->
                </div>
            </div>
        </div>

        <!-- Planta no encontrada -->
        <div id="planta-no-encontrada" class="empty-state hidden">
            <i class="fas fa-exclamation-triangle"></i>
            <h3>Planta no encontrada</h3>
            <p>La planta solicitada no existe o fue eliminada.</p>
            <a href="mis-plantas.html" class="btn btn-primary">
                <i class="fas fa-arrow-left"></i> Volver a Mis Plantas
            </a>
        </div>
    </div>

    <!-- Modal de cuidado -->
    <div id="modal-cuidado" class="modal">
        <div class="modal-content">
            <h3><i class="fas fa-hand-holding-water"></i> Registrar Cuidado</h3>
            <div class="form-group">
                <label for="tipo-cuidado">Tipo de cuidado:</label>
                <select id="tipo-cuidado">
                    <option value="riego">üíß Riego</option>
                    <option value="fertilizacion">üå± Fertilizaci√≥n</option>
                    <option value="poda">‚úÇÔ∏è Poda</option>
                    <option value="limpieza">üßΩ Limpieza de hojas</option>
                    <option value="trasplante">ü™¥ Trasplante</option>
                    <option value="fumigacion">üåø Fumigaci√≥n</option>
                    <option value="otro">üîß Otro</option>
                </select>
            </div>
            <div class="form-group">
                <label for="fecha-cuidado">Fecha del cuidado:</label>
                <input type="datetime-local" id="fecha-cuidado">
            </div>
            <div class="form-group">
                <label for="notas-cuidado">Observaciones:</label>
                <textarea id="notas-cuidado" rows="3" placeholder="Describe el cuidado realizado, observaciones, etc."></textarea>
            </div>
            <div class="form-group">
                <label for="cambio-estado">¬øCambiar estado de la planta?</label>
                <select id="cambio-estado">
                    <option value="">Mantener estado actual</option>
                    <option value="SALUDABLE">üü¢ Saludable</option>
                    <option value="NECESITA_AGUA">üü° Necesita agua</option>
                    <option value="ENFERMA">üî¥ Enferma</option>
                    <option value="MARCHITA">üü† Marchita</option>
                    <option value="FLORECIENDO">üå∏ Floreciendo</option>
                </select>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="cerrarModalCuidado()">Cancelar</button>
                <button class="btn btn-primary" onclick="guardarCuidado()">Registrar Cuidado</button>
            </div>
        </div>
    </div>

    <!-- Notificaci√≥n -->
    <div id="notification" class="notification"></div>

    <!-- AGREGAR ESTE SCRIPT -->
    <script src="js/plantas-api.js"></script>
    
    <script>
        // Variables globales
        let plantaActual = null;
        let plantaId = null;

        
        // Funci√≥n para obtener par√°metros de la URL
        function obtenerParametroURL(nombre) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(nombre);
        }

        // Funci√≥n para cargar planta
        async function cargarPlanta() {
	    plantaId = obtenerParametroURL('id');
	    
	    if (!plantaId) {
		mostrarError();
		return;
	    }

	    console.log('üîç Cargando planta desde MongoDB:', plantaId);

	    try {

		if (window.PlantasAPI) {
		    plantaActual = await PlantasAPI.obtenerPlantaPorId(plantaId);
		    
		    if (!plantaActual) {
		        console.log(' Planta no encontrada en MongoDB:', plantaId);
		        mostrarError();
		        return;
		    }
		    
		    console.log(' Planta cargada desde MongoDB:', plantaActual.apodo);
		    mostrarInformacionPlanta();
		    
		} else {
		    throw new Error('PlantasAPI no disponible');
		}
		
	    } catch (error) {
		console.error(' Error cargando planta:', error);
		mostrarError();
	    }
	}
        // Funci√≥n para mostrar error
        function mostrarError() {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('planta-no-encontrada').classList.remove('hidden');
        }

        // Funci√≥n para mostrar informaci√≥n de la planta
        function mostrarInformacionPlanta() {
	    const plantaCatalogo = plantaActual.planta; // Referencia directa de MongoDB
	    
	    // Ocultar loading
	    document.getElementById('loading').classList.add('hidden');
	    document.getElementById('contenido-planta').classList.remove('hidden');

	    // Actualizar t√≠tulo y breadcrumb
	    document.getElementById('titulo-planta').textContent = plantaActual.apodo;
	    document.getElementById('breadcrumb-nombre').textContent = plantaActual.apodo;
	    document.title = `${plantaActual.apodo} - PlantCare`;

	    // Configurar bot√≥n editar
	    document.getElementById('btn-editar').href = `editar-planta.html?id=${plantaActual.id}`;

	    // Informaci√≥n b√°sica
	    document.getElementById('apodo-planta').textContent = plantaActual.apodo;
	    document.getElementById('nombre-cientifico').textContent = plantaCatalogo ? 
		`${plantaCatalogo.nombreComun} (${plantaCatalogo.nombreCientifico})` : 'Informaci√≥n no disponible';

	    // Imagen
	    const imagen = document.getElementById('imagen-planta');
	    imagen.src = plantaActual.fotoPersonal || 
		`https://via.placeholder.com/400x300/81C784/FFFFFF?text=${encodeURIComponent(plantaActual.apodo)}`;
	    imagen.alt = plantaActual.apodo;

	    // Estado
	    const estadoSpan = document.getElementById('estado-planta');
	    estadoSpan.textContent = plantaActual.estado.replace('_', ' ');
	    estadoSpan.className = `plant-status status-${plantaActual.estado.toLowerCase()}`;

	    // Informaci√≥n de ubicaci√≥n y fechas
	    document.getElementById('ubicacion-planta').textContent = plantaActual.ubicacion;
	    document.getElementById('fecha-registro').textContent = 
		`Registrada el ${new Date(plantaActual.fechaRegistro).toLocaleDateString()}`;
	    document.getElementById('tipo-planta').textContent = 
		plantaCatalogo ? plantaCatalogo.tipo : 'No especificado';

	    // Descripci√≥n
	    if (plantaCatalogo && plantaCatalogo.descripcion) {
		document.getElementById('descripcion-planta').innerHTML = 
		    `<h4><i class="fas fa-info-circle"></i> Informaci√≥n de la Especie</h4><p>${plantaCatalogo.descripcion}</p>`;
	    }

	    // Notas personales
	    if (plantaActual.notas) {
		document.getElementById('notas-personales').classList.remove('hidden');
		document.getElementById('texto-notas').textContent = plantaActual.notas;
	    }

	    // Estad√≠sticas
	    actualizarEstadisticas();

	    // Resto de funciones...
	    mostrarCuidadosRecomendados(plantaCatalogo);
	    mostrarHistorialCuidados();
	    mostrarProximosCuidados();
	}

        // Funci√≥n para actualizar estad√≠sticas
        function actualizarEstadisticas() {
            const ahora = new Date();
            const fechaRegistro = new Date(plantaActual.fechaRegistro);
            const ultimoCuidado = new Date(plantaActual.ultimoCuidado);

            const diasRegistrada = Math.floor((ahora - fechaRegistro) / (1000 * 60 * 60 * 24));
            const diasUltimoCuidado = Math.floor((ahora - ultimoCuidado) / (1000 * 60 * 60 * 24));
            const totalCuidados = plantaActual.bitacoras ? plantaActual.bitacoras.length : 0;

            document.getElementById('dias-registrada').textContent = diasRegistrada;
            document.getElementById('total-cuidados').textContent = totalCuidados;
            document.getElementById('dias-ultimo-cuidado').textContent = diasUltimoCuidado;
            
            // Estado de salud basado en el estado actual
            const estadoSalud = {
                'SALUDABLE': 'üü¢',
                'NECESITA_AGUA': 'üü°',
                'ENFERMA': 'üî¥',
                'MARCHITA': 'üü†',
                'FLORECIENDO': 'üå∏'
            };
            document.getElementById('estado-salud').textContent = estadoSalud[plantaActual.estado] || '‚ùì';
        }

        // Funci√≥n para mostrar cuidados recomendados
        function mostrarCuidadosRecomendados(plantaCatalogo) {
            const container = document.getElementById('cuidados-recomendados');

            if (!plantaCatalogo || !plantaCatalogo.cuidados) {
                container.innerHTML = '<div class="empty-state"><i class="fas fa-info-circle"></i><h3>Sin informaci√≥n de cuidados</h3><p>No hay informaci√≥n espec√≠fica de cuidados para esta especie</p></div>';
                return;
            }

            container.innerHTML = plantaCatalogo.cuidados.map(cuidado => `
                <div class="card">
                    <h4><i class="fas fa-leaf"></i> ${cuidado.tipo}</h4>
                    <p><strong>Frecuencia:</strong> ${cuidado.frecuencia}</p>
                    <p>${cuidado.descripcion}</p>
                </div>
            `).join('');
        }

        // Funci√≥n para mostrar historial de cuidados
        function mostrarHistorialCuidados() {
            const container = document.getElementById('historial-cuidados');
            const bitacoras = plantaActual.bitacoras || [];

            if (bitacoras.length === 0) {
                container.innerHTML = '<div class="empty-state"><i class="fas fa-history"></i><h3>Sin historial</h3><p>A√∫n no se han registrado cuidados para esta planta</p></div>';
                return;
            }

            const historialOrdenado = bitacoras.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));

            container.innerHTML = `
                <div class="cards-grid">
                    ${historialOrdenado.map(cuidado => `
                        <div class="card">
                            <h4><i class="fas fa-droplet"></i> ${cuidado.tipo.charAt(0).toUpperCase() + cuidado.tipo.slice(1)}</h4>
                            <p><i class="fas fa-calendar"></i> ${new Date(cuidado.fecha).toLocaleDateString()}</p>
                            ${cuidado.notas ? `<p><i class="fas fa-sticky-note"></i> ${cuidado.notas}</p>` : ''}
                            <span class="plant-status status-saludable">Realizado</span>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Funci√≥n para mostrar pr√≥ximos cuidados
        function mostrarProximosCuidados() {
            const container = document.getElementById('proximos-cuidados');
            const ultimoCuidado = new Date(plantaActual.ultimoCuidado);
            const ahora = new Date();
            const diasSinCuidado = Math.floor((ahora - ultimoCuidado) / (1000 * 60 * 60 * 24));

            // Cuidados sugeridos basados en el tiempo transcurrido
            const cuidadosSugeridos = [];

            if (diasSinCuidado >= 7) {
                cuidadosSugeridos.push({
                    tipo: 'Riego',
                    prioridad: diasSinCuidado >= 14 ? 'alta' : 'media',
                    descripcion: 'Es hora de revisar si necesita agua'
                });
            }

            if (diasSinCuidado >= 30) {
                cuidadosSugeridos.push({
                    tipo: 'Fertilizaci√≥n',
                    prioridad: 'media',
                    descripcion: 'Considera aplicar fertilizante'
                });
            }

            if (diasSinCuidado >= 7) {
                cuidadosSugeridos.push({
                    tipo: 'Inspecci√≥n',
                    prioridad: 'baja',
                    descripcion: 'Revisar hojas y detectar problemas'
                });
            }

            if (cuidadosSugeridos.length === 0) {
                container.innerHTML = '<div class="empty-state"><i class="fas fa-check-circle"></i><h3>Al d√≠a con los cuidados</h3><p>Tu planta est√° bien cuidada por ahora</p></div>';
                return;
            }

            container.innerHTML = cuidadosSugeridos.map(cuidado => {
                const iconoPrioridad = {
                    'alta': 'üî¥',
                    'media': 'üü°',
                    'baja': 'üü¢'
                };

                return `
                    <div class="card">
                        <h4><i class="fas fa-calendar-check"></i> ${cuidado.tipo} ${iconoPrioridad[cuidado.prioridad]}</h4>
                        <p>${cuidado.descripcion}</p>
                        <p><strong>Prioridad:</strong> ${cuidado.prioridad.charAt(0).toUpperCase() + cuidado.prioridad.slice(1)}</p>
                        <button class="btn btn-primary" onclick="abrirModalCuidado('${cuidado.tipo.toLowerCase()}')">
                            <i class="fas fa-plus"></i> Registrar
                        </button>
                    </div>
                `;
            }).join('');
        }

        // Funci√≥n para abrir modal de cuidado
        function abrirModalCuidado(tipoSugerido = '') {
            document.getElementById('modal-cuidado').classList.add('visible');
            
            // Establecer fecha y hora actual
            const ahora = new Date();
            const fechaLocal = new Date(ahora.getTime() - ahora.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
            document.getElementById('fecha-cuidado').value = fechaLocal;

            // Preseleccionar tipo si se sugiere
            if (tipoSugerido) {
                document.getElementById('tipo-cuidado').value = tipoSugerido;
            }

            // Limpiar campos
            document.getElementById('notas-cuidado').value = '';
            document.getElementById('cambio-estado').value = '';
        }

        // Funci√≥n para cerrar modal de cuidado
        function cerrarModalCuidado() {
            document.getElementById('modal-cuidado').classList.remove('visible');
        }

        // Funci√≥n para guardar cuidado
        function guardarCuidado() {
            const tipoCuidado = document.getElementById('tipo-cuidado').value;
            const fechaCuidado = document.getElementById('fecha-cuidado').value;
            const notas = document.getElementById('notas-cuidado').value.trim();
            const nuevoEstado = document.getElementById('cambio-estado').value;

            if (!fechaCuidado) {
                mostrarNotificacion('Por favor selecciona una fecha', 'error');
                return;
            }

            // Crear nuevo cuidado
            const nuevoCuidado = {
                tipo: tipoCuidado,
                fecha: new Date(fechaCuidado).toISOString(),
                notas: notas || null,
                realizado: true
            };

            // Actualizar planta
            if (!plantaActual.bitacoras) plantaActual.bitacoras = [];
            plantaActual.bitacoras.push(nuevoCuidado);
            plantaActual.ultimoCuidado = nuevoCuidado.fecha;

            // Cambiar estado si se especifica
            if (nuevoEstado) {
                plantaActual.estado = nuevoEstado;
            }

            // Guardar en localStorage
            const plantas = JSON.parse(localStorage.getItem('plantasUsuario') || '[]');
            const indice = plantas.findIndex(p => p.id == plantaActual.id);
            if (indice !== -1) {
                plantas[indice] = plantaActual;
                localStorage.setItem('plantasUsuario', JSON.stringify(plantas));
                
                mostrarNotificacion('¬°Cuidado registrado exitosamente!', 'success');
                
                // Actualizar vista
                actualizarEstadisticas();
                mostrarHistorialCuidados();
                mostrarProximosCuidados();
                
                // Actualizar estado visual si cambi√≥
                if (nuevoEstado) {
                    const estadoSpan = document.getElementById('estado-planta');
                    estadoSpan.textContent = nuevoEstado.replace('_', ' ');
                    estadoSpan.className = `plant-status status-${nuevoEstado.toLowerCase()}`;
                }
                
                cerrarModalCuidado();
            }
        }

        // Funci√≥n para mostrar notificaciones
        function mostrarNotificacion(mensaje, tipo = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = mensaje;
            notification.className = `notification ${tipo} show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Funci√≥n para cerrar sesi√≥n
        function cerrarSesion() {
            if (confirm('¬øEst√°s seguro de que quieres cerrar sesi√≥n?')) {
                localStorage.removeItem('usuarioActual');
                window.location.href = 'index.html';
            }
        }

        // Event listener para cerrar modal al hacer clic fuera
        document.getElementById('modal-cuidado').addEventListener('click', function(e) {
            if (e.target === this) cerrarModalCuidado();
        });

        // Inicializaci√≥n cuando carga la p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            cargarPlanta();
        });
    </script>
</body>
</html>
