<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - PlantCare</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="/login/css/plantas.css">
</head>
<body>
<header class="header">
    <nav class="nav">
        <h1><i class="fas fa-seedling"></i> PlantCare</h1>
        <div class="nav-links">
            <a href="/web/plantas/dashboard2"><i class="fas fa-chart-pie"></i> Dashboard</a>
            <a href="/web/plantas/mis-plantas"><i class="fas fa-leaf"></i> Mis Plantas</a>
            <a href="/web/plantas/registro"> <i class="fas fa-plus"></i> Agregar Planta</a>
            <button id="btn-cerrar-sesion"><i class="fas fa-sign-out-alt"></i> Salir</button>
        </div>
    </nav>
</header>

<div class="main-content">
    <div class="breadcrumb">
        <i class="fas fa-home"></i> <a href="/web/index">Inicio</a> / Dashboard
    </div>

    <div class="page-header">
        <h1><i class="fas fa-chart-pie"></i> Dashboard Personal</h1>
        <div id="fecha-actual"></div>
    </div>

    <div class="cards-grid">
        <div class="card stat-card">
            <i class="fas fa-seedling"></i>
            <span class="stat-number" id="total-plantas">0</span>
            <span class="stat-label">Plantas Registradas</span>
        </div>
        <div class="card stat-card">
            <i class="fas fa-heart-pulse"></i>
            <span class="stat-number" id="plantas-saludables">0</span>
            <span class="stat-label">Plantas Saludables</span>
        </div>
        <div class="card stat-card">
            <i class="fas fa-exclamation-triangle"></i>
            <span class="stat-number" id="plantas-cuidado">0</span>
            <span class="stat-label">Necesitan Atenci√≥n</span>
        </div>
        <div class="card stat-card">
            <i class="fas fa-calendar-check"></i>
            <span class="stat-number" id="cuidados-hoy">0</span>
            <span class="stat-label">Cuidados Hoy</span>
        </div>
    </div>

    <div class="form-container">
        <h2><i class="fas fa-bell"></i> Plantas que Necesitan Atenci√≥n</h2>
        <div id="plantas-atencion" class="cards-grid"></div>
    </div>

    <div class="form-container">
        <h2><i class="fas fa-plus-circle"></i> √öltimas Plantas Agregadas</h2>
        <div id="ultimas-plantas" class="cards-grid"></div>
    </div>

    <div class="form-container">
        <h2><i class="fas fa-calendar-alt"></i> Pr√≥ximos Cuidados Programados</h2>
        <div id="proximos-cuidados"></div>
    </div>
</div>

<div id="notification" class="notification"></div>

<script src="/login/js/plantas-api.js"></script>
<script>
    // Variables globales
    let estadisticasUsuario = {
        totalPlantas: 0,
        plantasSaludables: 0,
        plantasNecesitanAtencion: 0
    };
    let plantasUsuario = [];

    // Inicializaci√≥n
    document.addEventListener('DOMContentLoaded', () => {
        actualizarFecha();
        cargarEstadisticas();
        inicializarEventListeners();

        // Recargar cada 5 minutos
        setInterval(cargarEstadisticas, 300000);
    });

    // Inicializa todos los event listeners
    function inicializarEventListeners() {
        // Bot√≥n cerrar sesi√≥n
        const btnCerrarSesion = document.getElementById('btn-cerrar-sesion');
        if (btnCerrarSesion) {
            btnCerrarSesion.addEventListener('click', cerrarSesion);
        }

        // Event delegation para botones de cuidado
        document.addEventListener('click', (event) => {
            // Botones "Cuidar Ahora"
            if (event.target.closest('.btn-cuidar-ahora')) {
                event.stopPropagation();
                const btn = event.target.closest('.btn-cuidar-ahora');
                const plantaId = btn.dataset.plantaId;
                redirigirACuidado(plantaId);
            }

            // Botones "Aplicar Cuidado"
            if (event.target.closest('.btn-aplicar-cuidado')) {
                const btn = event.target.closest('.btn-aplicar-cuidado');
                const plantaId = btn.dataset.plantaId;
                cuidarRapido(plantaId);
            }

            // Botones "Ver Planta"
            if (event.target.closest('.btn-ver-planta')) {
                const btn = event.target.closest('.btn-ver-planta');
                const plantaId = btn.dataset.plantaId;
                verPlanta(plantaId);
            }

            // Cards de plantas (clickeables)
            if (event.target.closest('.plant-card')) {
                const card = event.target.closest('.plant-card');
                const plantaId = card.dataset.plantaId;
                if (plantaId) {
                    verPlanta(plantaId);
                }
            }
        });
    }

    // Actualiza la fecha en el header
    function actualizarFecha() {
        const ahora = new Date();
        const opciones = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        const elemento = document.getElementById('fecha-actual');
        if (elemento) {
            elemento.textContent = ahora.toLocaleDateString('es-ES', opciones);
        }
    }

    // Cargar estad√≠sticas y plantas desde API
    async function cargarEstadisticas() {
        try {
            estadisticasUsuario = await PlantasAPI.obtenerEstadisticas();
            plantasUsuario = await PlantasAPI.obtenerMisPlantas();

            actualizarEstadisticas();
            mostrarPlantasAtencion();
            mostrarUltimasPlantas();
            mostrarProximosCuidados();
        } catch (error) {
            UIUtils.mostrarNotificacion('Error al cargar el dashboard.', 'error');
        }
    }

    // Actualiza los contadores con animaci√≥n
    function actualizarEstadisticas() {
        document.getElementById('total-plantas').textContent = `${estadisticasUsuario.totalPlantas || 0}`;
        document.getElementById('plantas-saludables').textContent = `${estadisticasUsuario.plantasSaludables || 0}`;
        document.getElementById('plantas-cuidado').textContent = `${estadisticasUsuario.plantasNecesitanAtencion || 0}`;
        document.getElementById('cuidados-hoy').textContent = `${calcularCuidadosRecientes()}`;
        animarContadores();
    }

    // Calcula cuidados aplicados en las √∫ltimas 24 horas
    function calcularCuidadosRecientes() {
        const hoy = new Date();
        const limite = new Date(hoy.getTime() - 24 * 60 * 60 * 1000);
        let cuidados = 0;

        plantasUsuario.forEach(planta => {
            if (planta.cuidados) {
                planta.cuidados.forEach(c => {
                    const fecha = new Date(String(c.fecha));
                    if (fecha >= limite) cuidados++;
                });
            }
        });
        return cuidados;
    }

    // Aplica animaci√≥n a los contadores
    function animarContadores() {
        ['total-plantas', 'plantas-saludables', 'plantas-cuidado', 'cuidados-hoy'].forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                el.style.animation = 'none';
                setTimeout(() => el.style.animation = 'pulse 0.6s ease-in-out', 10);
            }
        });
    }

    // Muestra plantas que necesitan atenci√≥n
    function mostrarPlantasAtencion() {
        const container = document.getElementById('plantas-atencion');
        const plantasAtencion = plantasUsuario.filter(planta => {
            return ['NECESITA_AGUA', 'ENFERMA', 'MARCHITA'].includes(planta.estado) ||
                (planta.ultimoCuidado && daysSince(planta.ultimoCuidado) > 7);
        });

        if (plantasAtencion.length === 0) {
            container.innerHTML = crearEstadoVacio('¬°Excelente!', 'Todas tus plantas est√°n bien cuidadas');
            return;
        }

        container.innerHTML = plantasAtencion.map(planta => {
            const estado = planta.estado.toLowerCase().replace('_', '-');
            const dias = daysSince(planta.ultimoCuidado || planta.fechaRegistro);
            const nombre = planta.planta?.nombreComun || 'Planta desconocida';

            return `
                <div class="card plant-card" data-planta-id="${planta.id}">
                    <div class="plant-image">
                        <img src="${planta.fotoPersonal || generarPlaceholder(planta.apodo)}" alt="${planta.apodo}">
                        <span class="plant-status status-${estado}">${planta.estado.replace('_', ' ')}</span>
                    </div>
                    <div class="plant-info">
                        <h3>${planta.apodo}</h3>
                        <div class="scientific-name">${nombre}</div>
                        <div class="plant-meta">
                            <span><i class="fas fa-map-marker-alt"></i> ${planta.ubicacion}</span>
                            <span><i class="fas fa-clock"></i> ${dias} d√≠as sin cuidado</span>
                        </div>
                        <div class="plant-actions">
                            <button class="btn btn-primary btn-cuidar-ahora" data-planta-id="${planta.id}">
                                <i class="fas fa-hand-holding-water"></i> Cuidar Ahora
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }

    // Muestra las √∫ltimas 3 plantas agregadas
    function mostrarUltimasPlantas() {
        const container = document.getElementById('ultimas-plantas');
        const ultimas = [...plantasUsuario]
            .sort((a, b) => new Date(b.fechaRegistro) - new Date(a.fechaRegistro))
            .slice(0, 3);

        if (ultimas.length === 0) {
            container.innerHTML = crearEstadoVacio(
                'Sin plantas registradas',
                'A√∫n no hay plantas. ¬°Agr√©galas pronto!'
            );
            return;
        }

        container.innerHTML = ultimas.map(planta => {
            const estado = planta.estado.toLowerCase().replace('_', '-');
            const dias = daysSince(planta.fechaRegistro);
            const nombre = planta.planta?.nombreComun || 'Planta desconocida';

            return `
                <div class="card plant-card" data-planta-id="${planta.id}">
                    <div class="plant-image">
                        <img src="${planta.fotoPersonal || generarPlaceholder(planta.apodo)}" alt="${planta.apodo}">
                        <span class="plant-status status-${estado}">${planta.estado.replace('_', ' ')}</span>
                    </div>
                    <div class="plant-info">
                        <h3>${planta.apodo}</h3>
                        <div class="scientific-name">${nombre}</div>
                        <div class="plant-meta">
                            <span><i class="fas fa-map-marker-alt"></i> ${planta.ubicacion}</span>
                            <span><i class="fas fa-calendar"></i> ${dias} d√≠as registrada</span>
                            <span><i class="fas fa-heart"></i> ${planta.cuidados?.length || 0} cuidados</span>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }

    // Muestra sugerencias de cuidados
    function mostrarProximosCuidados() {
        const container = document.getElementById('proximos-cuidados');
        const sugerencias = [];

        plantasUsuario.forEach(planta => {
            const dias = daysSince(planta.ultimoCuidado || planta.fechaRegistro);
            const tipo = planta.planta?.tipo;

            if (dias >= 7) {
                sugerencias.push({
                    planta: planta.apodo,
                    plantaId: planta.id,
                    tipo: 'Riego',
                    prioridad: dias >= 14 ? 'alta' : 'media',
                    descripcion: `${dias} d√≠as sin cuidado`,
                    icono: 'üíß'
                });
            }

            if (dias >= 30) {
                sugerencias.push({
                    planta: planta.apodo,
                    plantaId: planta.id,
                    tipo: 'Fertilizaci√≥n',
                    prioridad: 'media',
                    descripcion: 'Fertilizaci√≥n mensual recomendada',
                    icono: 'üå±'
                });
            }

            if (tipo === 'interior' && dias >= 14) {
                sugerencias.push({
                    planta: planta.apodo,
                    plantaId: planta.id,
                    tipo: 'Limpieza de hojas',
                    prioridad: 'baja',
                    descripcion: 'Limpieza de hojas para plantas de interior',
                    icono: 'üßΩ'
                });
            }
        });

        sugerencias.sort((a, b) => {
            const orden = { alta: 1, media: 2, baja: 3 };
            return orden[a.prioridad] - orden[b.prioridad];
        });

        if (sugerencias.length === 0) {
            container.innerHTML = crearEstadoVacio(
                'Al d√≠a con los cuidados',
                'Todas tus plantas est√°n bien cuidadas por ahora'
            );
            return;
        }

        container.innerHTML = `
            <div class="cards-grid">
                ${sugerencias.slice(0, 6).map(s => {
            const color = { alta: '#dc3545', media: '#ffc107', baja: '#28a745' }[s.prioridad];
            return `
                        <div class="card">
                            <h4 style="color: ${color};">${s.icono} ${s.tipo}</h4>
                            <p><strong>${s.planta}</strong></p>
                            <p><i class="fas fa-info-circle"></i> ${s.descripcion}</p>
                            <p><strong>Prioridad:</strong>
                               <span style="color: ${color}; font-weight: bold;">
                                   ${s.prioridad.charAt(0).toUpperCase() + s.prioridad.slice(1)}
                               </span>
                            </p>
                            <div class="plant-actions">
                                <button class="btn btn-primary btn-aplicar-cuidado" data-planta-id="${s.plantaId}">
                                    <i class="fas fa-plus"></i> Aplicar Cuidado
                                </button>
                                <button class="btn btn-secondary btn-ver-planta" data-planta-id="${s.plantaId}">
                                    <i class="fas fa-eye"></i> Ver Planta
                                </button>
                            </div>
                        </div>
                    `;
        }).join('')}
            </div>
        `;
    }

    // Calcula d√≠as transcurridos desde una fecha
    function daysSince(dateString) {
        const date = new Date(dateString);
        const now = new Date();
        return Math.floor((now - date) / (1000 * 60 * 60 * 24));
    }

    // Genera imagen placeholder
    function generarPlaceholder(texto) {
        return `https://via.placeholder.com/200x150/81C784/FFFFFF?text=${encodeURIComponent(texto)}`;
    }

    // Crea estado vac√≠o reutilizable
    function crearEstadoVacio(titulo, mensaje) {
        return `
            <div class="empty-state">
                <i class="fas fa-check-circle" style="color: var(--color-green-medium); font-size: 3rem;"></i>
                <h3>${titulo}</h3>
                <p>${mensaje}</p>
            </div>
        `;
    }

    // Acciones r√°pidas
    async function cuidarRapido(plantaId, tipo = 'riego') {
        try {
            await PlantasAPI.registrarCuidado(plantaId, tipo, 'Cuidado r√°pido desde dashboard');
            UIUtils.mostrarNotificacion(`${tipo.charAt(0).toUpperCase() + tipo.slice(1)} aplicado.`, 'success');
            setTimeout(cargarEstadisticas, 1000);
        } catch (error) {
            UIUtils.mostrarNotificacion('Error al aplicar cuidado.', 'error');
        }
    }

    function redirigirACuidado(plantaId) {
        window.location.href = `/web/plantas/cuidado?id=${plantaId}`;
    }

    function verPlanta(plantaId) {
        console.log('ID de planta:', plantaId);  // ‚Üê Agrega esto
        console.log('URL completa:', `/web/plantas/vista-planta?id=${plantaId}`);  // ‚Üê Y esto
        window.location.href = `/web/plantas/vista-planta?id=${plantaId}`;
    }

    function cerrarSesion() {
        if (confirm('¬øEst√°s seguro de que quieres cerrar sesi√≥n?')) {
            localStorage.removeItem('usuarioActual');
            window.location.replace('/web/login');
        }
    }
</script>
</body>
</html>