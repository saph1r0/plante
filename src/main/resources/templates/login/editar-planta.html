<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editar Planta - PlantCare</title>

    <!-- Iconos (Font Awesome) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <!-- Estilos principales -->
    <link rel="stylesheet" href="/login/css/plantas.css">

    <!-- Estilos espec铆ficos para esta p谩gina -->
    <style>
        .readonly-info {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        .readonly-fields {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-top: 1rem;
        }
        .readonly-fields span {
            color: #495057;
        }
        .readonly-fields strong {
            color: #28a745;
        }
        .btn-outline-danger {
            background: transparent;
            color: #dc3545;
            border: 1px solid #dc3545;
        }
        .btn-outline-danger:hover {
            background-color: #dc3545;
            color: white;
            border-color: #dc3545;
            transition: all 0.2s ease;
        }
    </style>
</head>
<body>
    <!-- ========================================
         HEADER DE NAVEGACIN
         ======================================== -->
    <header class="header">
        <nav class="nav">
            <h1><i class="fas fa-seedling"></i> PlantCare</h1>
            <div class="nav-links">
                <a href="/web/plantas/dashboard2"><i class="fas fa-chart-pie"></i> Dashboard</a>
                <a href="/web/plantas/mis-plantas"><i class="fas fa-leaf"></i> Mis Plantas</a>
                <a href="/web/plantas/registro"><i class="fas fa-plus"></i> Agregar Planta</a>
                <button onclick="cerrarSesion()">
                    <i class="fas fa-sign-out-alt"></i> Salir
                </button>
            </div>
        </nav>
    </header>

    <!-- ========================================
         CONTENIDO PRINCIPAL
         ======================================== -->
    <div class="main-content">

        <!-- Estado: Cargando -->
        <div id="loading" class="text-center" style="padding: 3rem;">
            <i class="fas fa-spinner fa-spin fa-3x" style="color: var(--color-green-medium);"></i>
            <p style="margin-top: 1rem; color: var(--color-gray-text);">Cargando informaci贸n de la planta...</p>
        </div>

        <!-- Estado: Error - Planta no encontrada -->
        <div id="planta-no-encontrada" class="hidden" style="text-align: center; padding: 3rem;">
            <i class="fas fa-exclamation-triangle fa-3x" style="color: #dc3545; margin-bottom: 1rem;"></i>
            <h2>Planta no encontrada</h2>
            <p style="color: var(--color-gray-text); margin: 1rem 0;">
                La planta que intentas editar no existe o fue eliminada.
            </p>
            <a href="/web/plantas/mis-plantas" class="btn btn-primary">
                <i class="fas fa-arrow-left"></i> Volver a Mis Plantas
            </a>
        </div>

        <!-- Formulario de edici贸n (visible cuando carga) -->
        <div id="contenido-edicion" class="hidden">

            <!-- Breadcrumb -->
            <div class="breadcrumb">
                <i class="fas fa-home"></i>
                <a href="/web/index">Inicio</a> /
                <a href="/web/plantas/mis-plantas">Mis Plantas</a> /
                <span id="breadcrumb-planta">Editar Planta</span>
            </div>

            <!-- Encabezado de p谩gina -->
            <div class="page-header">
                <h1><i class="fas fa-edit"></i> Editar <span id="titulo-planta"></span></h1>
                <a href="/web/plantas/mis-plantas" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Volver
                </a>
            </div>

            <!-- Informaci贸n de la especie (solo lectura) -->
            <div class="readonly-info">
                <h4><i class="fas fa-info-circle"></i> Informaci贸n de la Especie</h4>
                <div class="readonly-fields">
                    <span><strong>Nombre:</strong> <span id="nombre-catalogo"></span></span>
                    <span><strong>Nombre cient铆fico:</strong> <span id="cientifico-catalogo"></span></span>
                    <span><strong>Tipo:</strong> <span id="tipo-catalogo"></span></span>
                    <span><strong>Descripci贸n:</strong> <span id="descripcion-catalogo"></span></span>
                </div>
            </div>

            <!-- Formulario de edici贸n -->
            <div class="form-container">
                <form id="form-edicion" onsubmit="guardarCambios(event)">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="apodo"><i class="fas fa-heart"></i> Apodo *</label>
                            <input type="text" id="apodo" required placeholder="Ej: Mi rosa favorita">
                        </div>

                        <div class="form-group">
                            <label for="ubicacion"><i class="fas fa-map-marker-alt"></i> Ubicaci贸n *</label>
                            <input type="text" id="ubicacion" required placeholder="Ej: Jard铆n, Oficina">
                        </div>

                        <div class="form-group">
                            <label for="estado"><i class="fas fa-heart-pulse"></i> Estado actual</label>
                            <select id="estado">
                                <option value="SALUDABLE"> Saludable</option>
                                <option value="NECESITA_AGUA"> Necesita agua</option>
                                <option value="ENFERMA"> Enferma</option>
                                <option value="MARCHITA"> Marchita</option>
                                <option value="FLORECIENDO"> Floreciendo</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="fecha-obtencion"><i class="fas fa-calendar"></i> Fecha de obtenci贸n</label>
                            <input type="date" id="fecha-obtencion">
                        </div>

                        <div class="form-group full-width">
                            <label for="foto-url"><i class="fas fa-camera"></i> URL de foto personal</label>
                            <input type="url" id="foto-url" placeholder="https://ejemplo.com/foto.jpg" oninput="previsualizarFoto()">
                            <div style="margin-top: 1rem;">
                                <strong>Foto actual:</strong>
                                <img id="img-actual" src="" alt="Foto actual" style="max-width: 200px; border-radius: 8px; margin-top: 0.5rem;">
                            </div>
                            <div id="preview-foto" class="hidden" style="margin-top: 1rem;">
                                <strong>Nueva foto (vista previa):</strong>
                                <img id="img-preview" src="" alt="Vista previa" style="max-width: 200px; border-radius: 8px; margin-top: 0.5rem;">
                            </div>
                        </div>

                        <div class="form-group full-width">
                            <label for="notas"><i class="fas fa-sticky-note"></i> Notas personales</label>
                            <textarea id="notas" rows="4" placeholder="Observaciones o cuidados especiales..."></textarea>
                        </div>
                    </div>

                    <div class="info-automatica">
                        <small>
                            <i class="fas fa-info-circle"></i>
                            <span id="info-registro"></span>
                        </small>
                    </div>

                    <div id="errores-validacion" class="hidden" style="background: #f8d7da; color: #721c24; padding: 1rem; border-radius: 8px; margin: 1rem 0; border-left: 6px solid #dc3545;">
                        <h4><i class="fas fa-exclamation-triangle"></i> Errores:</h4>
                        <ul id="lista-errores" style="margin: 0.5rem 0 0 1.5rem;"></ul>
                    </div>

                    <div style="display: flex; gap: 1rem; justify-content: space-between; margin-top: 2rem;">
                        <div style="display: flex; gap: 1rem;">
                            <button type="button" class="btn btn-secondary" onclick="cancelarEdicion()">
                                <i class="fas fa-times"></i> Cancelar
                            </button>
                            <button type="button" class="btn btn-outline-danger" onclick="confirmarEliminar()">
                                <i class="fas fa-trash-alt"></i> Eliminar
                            </button>
                        </div>
                        <button type="submit" class="btn btn-primary" id="btn-guardar">
                            <i class="fas fa-save"></i> Guardar Cambios
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- MODALES -->
    <div id="modal-eliminar" class="modal">
        <div class="modal-content">
            <h3><i class="fas fa-exclamation-triangle"></i> Confirmar eliminaci贸n</h3>
            <p>驴Est谩s seguro de que quieres eliminar a <strong id="nombre-eliminar"></strong>? Esta acci贸n es irreversible.</p>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="cerrarModalEliminar()">Cancelar</button>
                <button class="btn btn-danger" onclick="eliminarPlanta()">Eliminar Definitivamente</button>
            </div>
        </div>
    </div>
    <div id="modal-cancelar" class="modal"> ... </div>
    <div id="notification" class="notification"></div>

    <!-- SCRIPTS -->
    <script src="/login/js/plantas-api.js"></script>
    <script>
        // ========================================
        // VARIABLES GLOBALES
        // ========================================
        let plantaId;
        let plantaActual;
        let datosOriginales;
        let hayCambios = false;

        // ========================================
        // CARGAR PLANTA DESDE EL BACKEND
        // ========================================
        async function cargarPlanta() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                plantaId = urlParams.get('id');

                if (!plantaId) throw new Error('ID no proporcionado');

                // 1. Obtener registro del microservicio de registros (8080) [cite: 19, 42]
                const registro = await PlantasAPI.obtenerPlantaPorId(plantaId);

                // 2. Orquestaci贸n: Obtener info del cat谩logo para mostrarla (solo lectura)
                const infoCatalogo = await CatalogoAPI.obtenerPorId(registro.plantaId);

                // Unimos los datos para la vista
                plantaActual = { ...registro, planta: infoCatalogo };
                plantaOriginal = plantaActual;

                // 3. Pintar los datos en el formulario
                mostrarFormulario();

            } catch (error) {
                console.error('Error al cargar datos:', error);
                mostrarError();
            }
        }

        // ========================================
        // MOSTRAR FORMULARIO CON DATOS
        // ========================================
        function mostrarFormulario() {
            const { planta: plantaCatalogo } = plantaActual;
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('contenido-edicion').classList.remove('hidden');

            document.getElementById('titulo-planta').textContent = plantaActual.apodo;
            document.getElementById('breadcrumb-planta').textContent = `Editar ${plantaActual.apodo}`;
            document.title = `Editar ${plantaActual.apodo} - PlantCare`;

            if (plantaCatalogo) {
                document.getElementById('nombre-catalogo').textContent = plantaCatalogo.nombreComun || 'No disponible';
                document.getElementById('cientifico-catalogo').textContent = plantaCatalogo.nombreCientifico || 'No disponible';
                document.getElementById('tipo-catalogo').textContent = plantaCatalogo.tipo || 'N/A';
                document.getElementById('descripcion-catalogo').textContent = plantaCatalogo.descripcion || 'Sin descripci贸n';
            }

            document.getElementById('apodo').value = plantaActual.apodo || '';
            document.getElementById('ubicacion').value = plantaActual.ubicacion || '';

            if (plantaActual.estado) {
                document.getElementById('estado').value = plantaActual.estado;
            }

            if (plantaActual.fechaRegistro) {
                const fecha = new Date(plantaActual.fechaRegistro);
                document.getElementById('fecha-obtencion').value = fecha.toISOString().split('T')[0];
            }

            document.getElementById('foto-url').value = plantaActual.fotoPersonal || '';
            document.getElementById('notas').value = plantaActual.notas || '';

            const imgActual = document.getElementById('img-actual');
            imgActual.src = plantaActual.fotoPersonal ||
                           (plantaCatalogo ? plantaCatalogo.imagenURL : '') ||
                           'https://via.placeholder.com/200';

            const fechaReg = new Date(plantaActual.fechaRegistro);
            const dias = Math.floor((new Date() - fechaReg) / (1000 * 60 * 60 * 24));
            document.getElementById('info-registro').textContent =
                `Registrada el ${fechaReg.toLocaleDateString()} (hace ${dias} d铆as)`;

            configurarDeteccionCambios();
        }

        // ========================================
        // DETECTAR CAMBIOS EN EL FORMULARIO
        // ========================================
        function configurarDeteccionCambios() {
            ['apodo', 'ubicacion', 'estado', 'fecha-obtencion', 'foto-url', 'notas'].forEach(id => {
                const el = document.getElementById(id);
                el?.addEventListener('input', () => hayCambios = true);
            });
        }

        // ========================================
        // PREVISUALIZAR FOTO
        // ========================================
        function previsualizarFoto() {
            const url = document.getElementById('foto-url').value.trim();
            const preview = document.getElementById('preview-foto');
            const img = document.getElementById('img-preview');

            if (url && url.startsWith('http')) {
                img.src = url;
                img.onerror = () => {
                    preview.classList.add('hidden');
                    mostrarNotificacion('URL de imagen inv谩lida', 'error');
                };
                img.onload = () => preview.classList.remove('hidden');
            } else {
                preview.classList.add('hidden');
            }
        }

        // ========================================
        // VALIDAR FORMULARIO
        // ========================================
        function validarFormulario() {
            const errores = [];
            const apodo = document.getElementById('apodo').value.trim();
            const ubicacion = document.getElementById('ubicacion').value.trim();
            const fotoUrl = document.getElementById('foto-url').value.trim();

            if (!apodo) errores.push('El apodo es obligatorio');
            else if (apodo.length < 2) errores.push('El apodo debe tener al menos 2 caracteres');

            if (!ubicacion) errores.push('La ubicaci贸n es obligatoria');

            if (fotoUrl && !fotoUrl.startsWith('http')) errores.push('La URL de la foto debe ser v谩lida');

            return errores;
        }

        function mostrarErrores(errores) {
            const container = document.getElementById('errores-validacion');
            const lista = document.getElementById('lista-errores');
            if (errores.length > 0) {
                lista.innerHTML = errores.map(e => `<li>${e}</li>`).join('');
                container.classList.remove('hidden');
                container.scrollIntoView({ behavior: 'smooth', block: 'center' });
            } else {
                container.classList.add('hidden');
            }
        }

        // ========================================
        // GUARDAR CAMBIOS
        // ========================================
        async function guardarCambios(event) {
            if (event) event.preventDefault();

            const btn = document.getElementById('btn-guardar');

            if (!btn) {
                console.error("No se encontr贸 el bot贸n con ID 'btn-guardar'");
                return;
            }

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';

            const datosActualizados = {
                plantaId: plantaOriginal.plantaId,
                apodo: document.getElementById('apodo').value.trim(),
                ubicacion: document.getElementById('ubicacion').value.trim(),
                estado: document.getElementById('estado').value,
                fotoPersonal: document.getElementById('foto-url').value.trim() || null,
                notas: document.getElementById('notas').value.trim() || null
            };

            try {
                await PlantasAPI.actualizarPlanta(plantaId, datosActualizados);

                hayCambios = false;
                UIUtils.mostrarNotificacion('隆Cambios guardados con 茅xito!', 'success');

                setTimeout(() => {
                    window.location.href = `/web/plantas/vista-planta?id=${plantaId}`;
                }, 1500);
            } catch (error) {
                console.error('Error al actualizar:', error);
                UIUtils.mostrarNotificacion('Error al guardar los cambios', 'error');
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-save"></i> Guardar Cambios';
            }
        }

        // ========================================
        // ELIMINAR PLANTA
        // ========================================
        function confirmarEliminar() {
            const modal = document.getElementById('modal-eliminar');
            const nombreTxt = document.getElementById('nombre-eliminar');

            if (plantaActual && modal) {
                nombreTxt.textContent = plantaActual.apodo;
                modal.classList.add('visible');
            }
        }

        async function eliminarPlanta() {
            try {
                await PlantasAPI.eliminarPlanta(plantaId);
                mostrarNotificacion('Planta eliminada exitosamente', 'success');
                setTimeout(() => window.location.href = '/web/plantas/mis-plantas', 1500);
            } catch (error) {
                mostrarNotificacion('Error al eliminar: ' + error.message, 'error');
            }
        }


        // ========================================
        // CANCELAR EDICIN
        // ========================================
        function cancelarEdicion() {
            if (hayCambios) {
                if (!confirm('Tienes cambios sin guardar. 驴Deseas salir de todas formas?')) {
                    return;
                }
            }
            window.location.href = '/web/plantas/mis-plantas';
        }
        function confirmarCancelacion() {
            window.location.href = '/web/plantas/mis-plantas';
        }


        // ========================================
        // MODALES
        // ========================================
        function cerrarModalEliminar() {
            document.getElementById('modal-eliminar').classList.remove('visible');
        }

        function cerrarModalCancelar() {
            document.getElementById('modal-cancelar').classList.remove('visible');
        }

        // ========================================
        // UTILIDADES
        // ========================================
        function obtenerParametroURL(nombre) {
            return new URLSearchParams(window.location.search).get(nombre);
        }

        function mostrarError() {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('planta-no-encontrada').classList.remove('hidden');
        }

        function mostrarNotificacion(mensaje, tipo = 'success') {
            const notif = document.getElementById('notification');
            notif.textContent = mensaje;
            notif.className = `notification ${tipo} show`;
            setTimeout(() => notif.classList.remove('show'), tipo === 'success' ? 3000 : 5000);
        }

        function cerrarSesion() {
            if (confirm('驴Est谩s seguro de que quieres cerrar sesi贸n?')) {
                localStorage.removeItem('usuarioActual');
                window.location.replace('/web/login');
            }
        }


        // ========================================
        // EVENT LISTENERS
        // ========================================
        document.getElementById('modal-eliminar').addEventListener('click', e => e.target === e.currentTarget && cerrarModalEliminar());
        document.getElementById('modal-cancelar').addEventListener('click', e => e.target === e.currentTarget && cerrarModalCancelar());

        window.addEventListener('beforeunload', e => {
            if (hayCambios) {
                e.returnValue = 'Tienes cambios sin guardar.';
                return e.returnValue;
            }
        });

        // ========================================
        // INICIALIZACIN
        // ========================================
        document.addEventListener('DOMContentLoaded', () => {
            const fechaInput = document.getElementById('fecha-obtencion');
            if (fechaInput) fechaInput.max = new Date().toISOString().split('T')[0];
            cargarPlanta();
        });
    </script>
</body>
</html>
